name: Update Forks
on:
  # Schedule updates weekly (every Monday at 00:00 UTC)
  schedule:
    - cron: "0 0 * * 1"
  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: write

jobs:
  determine-runner:
    name: Determine runner (self-hosted or fallback)
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.set-runner.outputs.use-runner }}
    steps:
      - name: Determine which runner to use
        id: set-runner
        uses: mikehardy/runner-fallback-action@v1
        with:
          # Prefer your self-hosted runner label(s); change if you use custom labels
          primary-runner: "self-hosted"
          # Fallback to GitHub-hosted if self-hosted is unavailable
          fallback-runner: "ubuntu-latest"
          # Must have org:admin permissions, GitHub runner APIs require it
          github-token: ${{ secrets.METRICS_TOKEN }}

  update-forks:
    needs: determine-runner
    runs-on: ${{ fromJson(needs.determine-runner.outputs.runner) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process forks and update
        id: process-forks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Initialize counters
          updated_count=0
          skipped_count=0
          failed_count=0
          no_changes_count=0
          
          # Initialize job summary
          echo "# Fork Update Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get all repositories for the authenticated user that are forks
          echo "Fetching forked repositories..."
          if ! curl -s -f -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/user/repos?per_page=100&type=owner&affiliation=owner" | \
            jq -r '.[] | select(.fork == true) | [.full_name, .parent.full_name, .default_branch] | @tsv' > /tmp/forks.txt; then
            echo "::error::Failed to fetch repository list from GitHub API"
            echo "**Error:** Failed to fetch repositories" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          fork_count=$(wc -l < /tmp/forks.txt | tr -d ' ')
          
          if [ "$fork_count" -eq 0 ]; then
            echo "No forks found."
            echo "**No forks found.**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "Found $fork_count fork(s)"
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Process each fork (using while read to preserve counter variables)
          while IFS=$'\t' read -r fork_name parent_name default_branch; do
            echo ""
            echo "Processing fork: $fork_name (parent: $parent_name, branch: $default_branch)"
            
            # Check if fork is ahead of upstream using GitHub API
            compare_url="https://api.github.com/repos/$fork_name/compare/$parent_name:$default_branch...$default_branch"
            compare_result=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "$compare_url")
            
            # Check if API call was successful
            if echo "$compare_result" | jq -e '.message' >/dev/null 2>&1; then
              # API returned an error message
              error_msg=$(echo "$compare_result" | jq -r '.message // "Unknown error"')
              echo "::error::Failed to compare $fork_name: $error_msg"
              echo "## ❌ $fork_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Status:** Failed to compare with upstream" >> $GITHUB_STEP_SUMMARY
              echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
              echo "**Error:** $error_msg" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              failed_count=$((failed_count + 1))
              continue
            fi
            
            ahead_by=$(echo "$compare_result" | jq -r '.ahead_by // 0')
            behind_by=$(echo "$compare_result" | jq -r '.behind_by // 0')
            status=$(echo "$compare_result" | jq -r '.status // "unknown"')
            
            echo "  Status: $status, Ahead: $ahead_by, Behind: $behind_by"
            
            if [ "$ahead_by" -gt 0 ]; then
              # Fork has local commits - skip with warning
              echo "::warning::$fork_name has $ahead_by commit(s) ahead of upstream. Manual intervention required."
              echo "## ⚠️ $fork_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Status:** Skipped (has local commits)" >> $GITHUB_STEP_SUMMARY
              echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
              echo "**Ahead by:** $ahead_by commit(s)" >> $GITHUB_STEP_SUMMARY
              echo "**Behind by:** $behind_by commit(s)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:** This fork has local commits. You need to manually merge or rebase." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              skipped_count=$((skipped_count + 1))
            elif [ "$behind_by" -eq 0 ]; then
              # Already up to date
              echo "  ✓ Already up to date"
              echo "## ✅ $fork_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Status:** Up to date" >> $GITHUB_STEP_SUMMARY
              echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              no_changes_count=$((no_changes_count + 1))
            else
              # Fork is behind - try to sync using GitHub API
              echo "  Attempting to sync fork (behind by $behind_by commits)..."
              
              # Use GitHub's merge upstream API endpoint
              sync_result=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$fork_name/merge-upstream" \
                -d "{\"branch\":\"$default_branch\"}")
              
              http_code=$(echo "$sync_result" | tail -n1)
              response_body=$(echo "$sync_result" | sed '$d')
              
              if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ] || [ "$http_code" -eq 204 ]; then
                # Success
                merge_type=$(echo "$response_body" | jq -r '.merge_type // "fast-forward"')
                echo "  ✓ Successfully synced fork ($merge_type)"
                echo "## ✅ $fork_name" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Status:** Successfully updated" >> $GITHUB_STEP_SUMMARY
                echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
                echo "**Commits synced:** $behind_by" >> $GITHUB_STEP_SUMMARY
                echo "**Merge type:** $merge_type" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                updated_count=$((updated_count + 1))
              elif [ "$http_code" -eq 409 ]; then
                # Conflict detected
                message=$(echo "$response_body" | jq -r '.message // "Merge conflict"')
                echo "::warning::$fork_name cannot be auto-merged: $message"
                echo "## ⚠️ $fork_name" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Status:** Merge conflict" >> $GITHUB_STEP_SUMMARY
                echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
                echo "**Error:** $message" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Action Required:** Manual merge required due to conflicts." >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                skipped_count=$((skipped_count + 1))
              else
                # Other error
                message=$(echo "$response_body" | jq -r '.message // "Unknown error"')
                echo "::error::Failed to sync $fork_name: $message (HTTP $http_code)"
                echo "## ❌ $fork_name" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Status:** Failed" >> $GITHUB_STEP_SUMMARY
                echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
                echo "**Error:** $message (HTTP $http_code)" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                failed_count=$((failed_count + 1))
              fi
            fi
          done < /tmp/forks.txt
          
          # Add summary to job summary
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Forks:** $fork_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Updated:** $updated_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped (local changes/conflicts):** $skipped_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Already up to date:** $no_changes_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $failed_count" >> $GITHUB_STEP_SUMMARY
          
          # Set outputs
          echo "updated_count=$updated_count" >> $GITHUB_OUTPUT
          echo "skipped_count=$skipped_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          echo "no_changes_count=$no_changes_count" >> $GITHUB_OUTPUT
          echo "total_count=$fork_count" >> $GITHUB_OUTPUT
