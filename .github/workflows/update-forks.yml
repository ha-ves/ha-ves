name: Update Forks
on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  determine-runner:
    name: Determine runner (self-hosted or fallback)
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.set-runner.outputs.use-runner }}
    steps:
      - name: Determine which runner to use
        id: set-runner
        uses: mikehardy/runner-fallback-action@v1
        with:
          primary-runner: "self-hosted"
          fallback-runner: "ubuntu-latest"
          github-token: ${{ secrets.METRICS_TOKEN }}

  update-forks:
    needs: determine-runner
    runs-on: ${{ fromJson(needs.determine-runner.outputs.runner) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process forks and update
        id: process-forks
        env:
          GH_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          # Initialize counters
          updated_count=0
          skipped_count=0
          failed_count=0
          no_changes_count=0

          # Function to escape HTML special characters
          html_escape() {
            echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g'
          }

          # Initialize job summary
          echo "# Fork Update Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize HTML email report (static header only ‚Äî no $() expansion)
          cat > /tmp/email_report.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; margin: 20px; background-color: #f6f8fa; line-height: 1.5; }
              .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
              h1 { color: #24292f; border-bottom: 1px solid #d0d7de; padding-bottom: 10px; }
              h2 { color: #24292f; margin-top: 24px; font-size: 20px; }
              .meta { color: #57606a; font-size: 14px; margin-bottom: 20px; }
              .fork-item { background: #f6f8fa; padding: 16px; margin: 12px 0; border-radius: 6px; border-left: 3px solid #d0d7de; }
              .fork-item.success { border-left-color: #2da44e; background: #dafbe1; }
              .fork-item.warning { border-left-color: #fb8500; background: #fff8c5; }
              .fork-item.error { border-left-color: #cf222e; background: #ffebe9; }
              .fork-item.info { border-left-color: #0969da; background: #ddf4ff; }
              .fork-name { font-weight: 600; font-size: 16px; margin-bottom: 8px; }
              .fork-status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 8px; }
              .status-updated { background: #2da44e; color: white; }
              .status-skipped { background: #fb8500; color: white; }
              .status-failed { background: #cf222e; color: white; }
              .status-uptodate { background: #0969da; color: white; }
              .detail { color: #57606a; font-size: 14px; margin: 4px 0; }
              .summary { background: #ddf4ff; padding: 16px; border-radius: 6px; margin: 20px 0; border-left: 3px solid #0969da; }
              .summary-item { margin: 4px 0; }
              strong { color: #24292f; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üîÑ Fork Update Report</h1>
          HTMLEOF

          # Append the date line separately so $(date) expands correctly
          echo "      <div class=\"meta\">Generated: <span id=\"generated-utc\" data-epoch=\"$(date -u +%s)\">$(date -u '+%Y-%m-%d %H:%M:%S UTC')</span></div>" >> /tmp/email_report.html

          # Fetch forked repositories using gh CLI
          echo "Fetching forked repositories..."
          if ! gh repo list "$(gh api user --jq .login)" --fork --json nameWithOwner,parent,defaultBranchRef --limit 200 \  
            --jq '.[] | [.nameWithOwner, (.parent.owner.login + "/" + .parent.name), .defaultBranchRef.name] | @tsv' \
            > /tmp/forks.txt; then
            echo "::error::Failed to fetch repository list"
            echo "**Error:** Failed to fetch repositories" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          fork_count=$(wc -l < /tmp/forks.txt | tr -d ' ')

          if [ "$fork_count" -eq 0 ]; then
            echo "No forks found."
            echo "**No forks found.**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "Found $fork_count fork(s)"
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          while IFS=$'\t' read -r fork_name default_branch; do
            echo ""
            echo "Processing fork: $fork_name ($default_branch)"

            # Check ahead/behind using gh api
            compare_result=$(gh api "repos/$fork_name/compare/$parent_name:$default_branch...$default_branch" 2>&1)
            if [ $? -ne 0 ]; then
              error_msg=$(echo "$compare_result" | head -1)
              echo "::error::Failed to compare $fork_name: $error_msg"

              echo "## ‚ùå $fork_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Status:** Failed to compare with upstream" >> $GITHUB_STEP_SUMMARY
              echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
              echo "**Error:** $error_msg" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              fork_name_esc=$(html_escape "$fork_name")
              parent_name_esc=$(html_escape "$parent_name")
              error_msg_esc=$(html_escape "$error_msg")
              cat >> /tmp/email_report.html << EOF
              <div class="fork-item error">
                <div class="fork-name">‚ùå $fork_name_esc</div>
                <span class="fork-status status-failed">Failed</span>
                <div class="detail"><strong>Status:</strong> Failed to compare with upstream</div>
                <div class="detail"><strong>Upstream:</strong> $parent_name_esc</div>
                <div class="detail"><strong>Error:</strong> $error_msg_esc</div>
              </div>
              EOF

              failed_count=$((failed_count + 1))
              continue
            fi

            ahead_by=$(echo "$compare_result" | jq -r '.ahead_by // 0')
            behind_by=$(echo "$compare_result" | jq -r '.behind_by // 0')

            echo "  Ahead: $ahead_by, Behind: $behind_by"

            if [ "$ahead_by" -gt 0 ]; then
              echo "::warning::$fork_name has $ahead_by commit(s) ahead of upstream. Manual intervention required."

              echo "## ‚ö†Ô∏è $fork_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Status:** Skipped (has local commits)" >> $GITHUB_STEP_SUMMARY
              echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
              echo "**Ahead by:** $ahead_by commit(s)" >> $GITHUB_STEP_SUMMARY
              echo "**Behind by:** $behind_by commit(s)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Action Required:** This fork has local commits. You need to manually merge or rebase." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              fork_name_esc=$(html_escape "$fork_name")
              parent_name_esc=$(html_escape "$parent_name")
              cat >> /tmp/email_report.html << EOF
              <div class="fork-item warning">
                <div class="fork-name">‚ö†Ô∏è $fork_name_esc</div>
                <span class="fork-status status-skipped">Skipped</span>
                <div class="detail"><strong>Status:</strong> Skipped (has local commits)</div>
                <div class="detail"><strong>Upstream:</strong> $parent_name_esc</div>
                <div class="detail"><strong>Ahead by:</strong> $ahead_by commit(s)</div>
                <div class="detail"><strong>Behind by:</strong> $behind_by commit(s)</div>
                <div class="detail"><strong>Action Required:</strong> This fork has local commits. You need to manually merge or rebase.</div>
              </div>
              EOF

              skipped_count=$((skipped_count + 1))

            elif [ "$behind_by" -eq 0 ]; then
              echo "  ‚úì Already up to date"

              echo "## ‚úÖ $fork_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Status:** Up to date" >> $GITHUB_STEP_SUMMARY
              echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              fork_name_esc=$(html_escape "$fork_name")
              parent_name_esc=$(html_escape "$parent_name")
              cat >> /tmp/email_report.html << EOF
              <div class="fork-item info">
                <div class="fork-name">‚úÖ $fork_name_esc</div>
                <span class="fork-status status-uptodate">Up to date</span>
                <div class="detail"><strong>Upstream:</strong> $parent_name_esc</div>
              </div>
              EOF

              no_changes_count=$((no_changes_count + 1))

            else
              echo "  Attempting to sync fork (behind by $behind_by commits)..."

              sync_output=$(gh repo sync "$fork_name" --branch "$default_branch" 2>&1)
              sync_exit=$?

              if [ $sync_exit -eq 0 ]; then
                echo "  ‚úì Successfully synced fork"

                echo "## ‚úÖ $fork_name" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Status:** Successfully updated" >> $GITHUB_STEP_SUMMARY
                echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
                echo "**Commits synced:** $behind_by" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY

                fork_name_esc=$(html_escape "$fork_name")
                parent_name_esc=$(html_escape "$parent_name")
                cat >> /tmp/email_report.html << EOF
                <div class="fork-item success">
                  <div class="fork-name">‚úÖ $fork_name_esc</div>
                  <span class="fork-status status-updated">Updated</span>
                  <div class="detail"><strong>Status:</strong> Successfully updated</div>
                  <div class="detail"><strong>Upstream:</strong> $parent_name_esc</div>
                  <div class="detail"><strong>Commits synced:</strong> $behind_by</div>
                </div>
                EOF

                updated_count=$((updated_count + 1))

              else
                # Check if it's a conflict vs other failure
                if echo "$sync_output" | grep -qi "conflict"; then
                  echo "::warning::$fork_name cannot be auto-synced: merge conflict"

                  echo "## ‚ö†Ô∏è $fork_name" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Status:** Merge conflict" >> $GITHUB_STEP_SUMMARY
                  echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
                  echo "**Action Required:** Manual merge required due to conflicts." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  fork_name_esc=$(html_escape "$fork_name")
                  parent_name_esc=$(html_escape "$parent_name")
                  cat >> /tmp/email_report.html << EOF
                  <div class="fork-item warning">
                    <div class="fork-name">‚ö†Ô∏è $fork_name_esc</div>
                    <span class="fork-status status-skipped">Merge conflict</span>
                    <div class="detail"><strong>Status:</strong> Merge conflict</div>
                    <div class="detail"><strong>Upstream:</strong> $parent_name_esc</div>
                    <div class="detail"><strong>Action Required:</strong> Manual merge required due to conflicts.</div>
                  </div>
                  EOF

                  skipped_count=$((skipped_count + 1))
                else
                  message=$(echo "$sync_output" | head -1)
                  echo "::error::Failed to sync $fork_name: $message"

                  echo "## ‚ùå $fork_name" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Status:** Failed" >> $GITHUB_STEP_SUMMARY
                  echo "**Upstream:** $parent_name" >> $GITHUB_STEP_SUMMARY
                  echo "**Error:** $message" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  fork_name_esc=$(html_escape "$fork_name")
                  parent_name_esc=$(html_escape "$parent_name")
                  message_esc=$(html_escape "$message")
                  cat >> /tmp/email_report.html << EOF
                  <div class="fork-item error">
                    <div class="fork-name">‚ùå $fork_name_esc</div>
                    <span class="fork-status status-failed">Failed</span>
                    <div class="detail"><strong>Status:</strong> Failed</div>
                    <div class="detail"><strong>Upstream:</strong> $parent_name_esc</div>
                    <div class="detail"><strong>Error:</strong> $message_esc</div>
                  </div>
                  EOF

                  failed_count=$((failed_count + 1))
                fi
              fi
            fi
          done < /tmp/forks.txt

          # Add summary to job summary
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Forks:** $fork_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Updated:** $updated_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped (local changes/conflicts):** $skipped_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Already up to date:** $no_changes_count" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $failed_count" >> $GITHUB_STEP_SUMMARY

          # Finalize email report
          cat >> /tmp/email_report.html << EOF
          <div class="summary">
            <h2>Summary</h2>
            <div class="summary-item"><strong>Total Forks:</strong> $fork_count</div>
            <div class="summary-item"><strong>‚úÖ Updated:</strong> $updated_count</div>
            <div class="summary-item"><strong>‚ö†Ô∏è Skipped (local changes/conflicts):</strong> $skipped_count</div>
            <div class="summary-item"><strong>‚úÖ Already up to date:</strong> $no_changes_count</div>
            <div class="summary-item"><strong>‚ùå Failed:</strong> $failed_count</div>
          </div>
          <div class="meta">
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View workflow run</a>
          </div>
          EOF

          # Set outputs
          echo "updated_count=$updated_count" >> $GITHUB_OUTPUT
          echo "skipped_count=$skipped_count" >> $GITHUB_OUTPUT
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          echo "no_changes_count=$no_changes_count" >> $GITHUB_OUTPUT
          echo "total_count=$fork_count" >> $GITHUB_OUTPUT

      - name: Send email notification (SMTP)
        if: always()
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM || secrets.SMTP_USERNAME }}
          EMAIL_TO: ${{ secrets.EMAIL_TO || secrets.SMTP_USERNAME }}
        run: |
          cat >> /tmp/email_report.html << EOF
          </div>
          <script>
            const elem = document.getElementById("generated-utc");
            const epoch = elem.dataset.epoch;
            if (epoch) {
              const date = new Date(parseInt(epoch, 10) * 1000);
              elem.textContent = date.toString();
            }
          </script>
          </body>
          </html>
          EOF
        
          if [ -z "$SMTP_USERNAME" ] || [ -z "$SMTP_PASSWORD" ]; then
            echo "‚ö†Ô∏è SMTP credentials not configured. Skipping email notification."
            echo "To enable email notifications, set the following secrets:"
            echo "  - SMTP_USERNAME (required)"
            echo "  - SMTP_PASSWORD (required)"
            echo "  - SMTP_HOST (optional, defaults to smtp.gmail.com)"
            echo "  - SMTP_PORT (optional, defaults to 587)"
            echo "  - EMAIL_FROM (optional, defaults to SMTP_USERNAME)"
            echo "  - EMAIL_TO (optional, defaults to SMTP_USERNAME)"
            exit 0
          fi

          SMTP_HOST_CLEAN=$(echo "$SMTP_HOST" | tr -d '\n\r' | tr -cd '[:alnum:].-')
          SMTP_PORT_CLEAN=$(echo "$SMTP_PORT" | tr -d '\n\r' | tr -cd '[:digit:]')
          EMAIL_FROM_CLEAN=$(echo "$EMAIL_FROM" | tr -d '\n\r' | head -c 254)
          EMAIL_TO_CLEAN=$(echo "$EMAIL_TO" | tr -d '\n\r' | head -c 254)
          SMTP_USERNAME_CLEAN=$(echo "$SMTP_USERNAME" | tr -d '\n\r')

          sudo apt-get update -qq
          sudo apt-get install -y -qq msmtp msmtp-mta mailutils

          cat > ~/.msmtprc << EOF
          defaults
          auth           on
          tls            on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          logfile        ~/.msmtp.log

          account        default
          host           $SMTP_HOST_CLEAN
          port           $SMTP_PORT_CLEAN
          from           $EMAIL_FROM_CLEAN
          user           $SMTP_USERNAME_CLEAN
          password       $SMTP_PASSWORD
          EOF

          chmod 600 ~/.msmtprc

          subject_raw="Fork Update Report - ${{ steps.process-forks.outputs.updated_count }} updated, ${{ steps.process-forks.outputs.skipped_count }} skipped"
          subject=$(echo "$subject_raw" | tr -d '\n\r' | head -c 200)

          (
            echo "To: $EMAIL_TO_CLEAN"
            echo "From: $EMAIL_FROM_CLEAN"
            echo "Subject: $subject"
            echo "Content-Type: text/html; charset=UTF-8"
            echo ""
            cat /tmp/email_report.html
          ) | msmtp -t

          echo "‚úÖ Email notification sent successfully to: $EMAIL_TO_CLEAN"
